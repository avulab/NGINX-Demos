version: 2.1
jobs:
  Infra:
    machine: true  
    working_directory: ~/NGINX-Demos/nginx-hello

    steps:
      - checkout:
          path: ~/NGINX-Demos

      - run:
          name: install dependencies
          command: |
            make awsinstall

      - run:
          name: Build Infra
          command: |
            make infra 
      - persist_to_workspace:
          root: ~/.kube
          paths:
            - config
    
  Lint:
    machine: true  
    working_directory: ~/NGINX-Demos/nginx-hello

    steps:
      - checkout:
          path: ~/NGINX-Demos

      - run:
          name: install dependencies
          command: |
            make lintinstall

      - run:
          name: run lint
          command: |
            make lint 

  Build_and_Upload:
    machine: true  
    working_directory: ~/NGINX-Demos/nginx-hello

    steps:
      - checkout:
          path: ~/NGINX-Demos

      - run:
          name: build image
          command: |
            make build 

      - run:
          name: upload image
          command: |
            make login tag upload 

  Deploy_and_Run:
    machine: true
    working_directory: ~/NGINX-Demos/nginx-hello

    steps:
      - checkout:
          path: ~/NGINX-Demos
      - attach_workspace:
          at: ~/.kube
      - run:
          name: Config kubectl
          command: |
            make awsinstall config
      - run:
          name: rolling update
          command: |
            make delpoy

workflows:
  version: 2
  lint-build-and-deploy:
    jobs:
      - Infra
      - Lint
      - Build_and_Upload:
          requires:
            - Lint
      - Deploy_and_Run:
          requires:
            - Build_and_Upload