version: 2.1
jobs:
  Lint:
    machine: true  
    working_directory: ~/NGINX-Demos/nginx-hello

    steps:
      - checkout:
          path: ~/NGINX-Demos

      - run:
          name: install dependencies
          command: |
            make install

      - run:
          name: run lint
          command: |
            make lint 

  Build & Upload:
    machine: true  
    working_directory: ~/NGINX-Demos/nginx-hello

    steps:
      - checkout:
          path: ~/NGINX-Demos

      - run:
          name: build image
          command: |
            make build 

      - run:
          name: upload image
          command: |
            make login tag upload 

  Deploy & Run:
    docker: amazon/aws-cli  
    working_directory: ~/NGINX-Demos/nginx-hello

    steps:
      - checkout:
          path: ~/NGINX-Demos
      - run:
          name: build infra
          command: |
            make infra 

workflows:
  version: 2
  lint-build-and-deploy:
    jobs:
      - Lint
      - Build & Upload:
          requires:
            - Lint
      - Deploy & Run:
          requires:
            - Build & Upload